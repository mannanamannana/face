<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AR Hair Engine</title>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#000;color:#fff;overflow:hidden}

/* UI Layer */
#ui{
position:absolute;
top:0;
right:0;
width:320px;
height:100%;
background:#111;
border-left:1px solid #222;
padding:20px;
overflow-y:auto;
z-index:10;
}

h2{margin-bottom:15px}
.product{
background:#1a1a1a;
border:1px solid #222;
padding:12px;
margin-bottom:10px;
cursor:pointer;
transition:.3s;
}
.product:hover{background:#333}

button{
width:100%;
padding:12px;
margin-top:15px;
background:#fff;
color:#000;
border:none;
cursor:pointer;
}
canvas{display:block}
</style>
</head>

<body>

<video id="video" style="display:none"></video>
<div id="ui">
<h2>Marketplace</h2>

<div class="product" data-model="hair1.glb">Classic Braids</div>
<div class="product" data-model="hair2.glb">Afro Volume</div>
<div class="product" data-model="hair3.glb">Modern Dreads</div>

<button id="capture">Capture</button>
</div>

<script>
const video = document.getElementById('video');

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

camera.position.z = 5;

const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(0,1,2);
scene.add(light);

let hairMesh = new THREE.Mesh(
  new THREE.SphereGeometry(1.2,32,32),
  new THREE.MeshStandardMaterial({color:0xffffff})
);
scene.add(hairMesh);

const occlusionMaterial = new THREE.MeshBasicMaterial({
  color:0x000000,
  depthWrite:true,
  colorWrite:false
});

const occlusionMesh = new THREE.Mesh(
  new THREE.SphereGeometry(1,32,32),
  occlusionMaterial
);
scene.add(occlusionMesh);

const faceMesh = new FaceMesh({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
});

faceMesh.setOptions({
  maxNumFaces:1,
  refineLandmarks:true,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

faceMesh.onResults(results=>{
  if(!results.multiFaceLandmarks.length) return;

  const landmarks = results.multiFaceLandmarks[0];

  const left = landmarks[234];
  const right = landmarks[454];
  const top = landmarks[10];

  const width = Math.abs(right.x - left.x);
  const height = Math.abs(top.y - left.y);

  const centerX = (left.x + right.x)/2 - 0.5;
  const centerY = -((top.y) - 0.5);

  hairMesh.position.x = centerX*5;
  hairMesh.position.y = centerY*5 + 1;
  hairMesh.scale.set(width*6,width*6,width*6);

  occlusionMesh.position.copy(hairMesh.position);
  occlusionMesh.scale.copy(hairMesh.scale);
});

const cam = new Camera(video,{
  onFrame: async ()=>{await faceMesh.send({image:video});},
  width:640,
  height:480
});
cam.start();

function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene,camera);
}
animate();

/* Marketplace logic */
document.querySelectorAll('.product').forEach(el=>{
  el.onclick=()=>{
    hairMesh.material.color.set(0xffffff);
    alert("Model system ready for GLB loader integration.");
  }
});

/* Capture */
document.getElementById("capture").onclick=()=>{
  const link=document.createElement("a");
  link.download="capture.png";
  link.href=renderer.domElement.toDataURL();
  link.click();
};
</script>
</body>
</html>
